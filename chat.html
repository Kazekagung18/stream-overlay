<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Overlay - Special Event</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap">
<script src="https://socialstream.ninja/libs/colours.js" type="text/javascript"></script>
<style>
body, html {
display: flex;
flex-wrap: wrap;
justify-content: center;
align-items: flex-end;
margin: 0;
padding: 0;
width: 100%;
height: 100%;
font-family: 'Poppins', sans-serif;
background: transparent !important;
background-color: transparent !important;
overflow: hidden;
box-sizing: border-box;
perspective: 1000px;
}
* {
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}
#chat-container {
display: flex;
flex-wrap: wrap;
bottom: 20px;
left: 50%;
transform: translateX(0%);
width: 100%;
max-width: 800px;
height: calc(100vh - 40px);
overflow: hidden;
padding: 0 60px 0 20px;
box-sizing: border-box;
transform-style: flat;
background: transparent;
border: none !important;
outline: none !important;
box-shadow: none !important;
}


#message-list-wrapper {
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
align-items: stretch;
transform: none;
transform-style: flat;
transform-origin: left center;
perspective: none;
background: transparent;
overflow-y: auto;
overflow-x: hidden;
scroll-behavior: smooth;

/* Geser ke kiri biar garis hilang */
margin-left: -40px !important;
padding-left: 40px !important;
padding-right:  !important;
padding-top: 0 !important;
padding-bottom: 0 !important;

/* Hide scrollbar completely */
scrollbar-width: none;
-ms-overflow-style: none;
}


/* Back to bottom button */
#scroll-to-bottom {
position: fixed;
bottom: 70px;  /* GESER KE ATAS - makin besar makin atas */
left: 60%;
transform: translateX(-50%);
width: 100px;
height: 100px;
padding: 0;
margin: 0;
background: #E62429;
color: #FFFFFF;
border: 3px solid #FFFFFF;
border-radius: 50%;
font-family: 'Poppins', sans-serif;
font-weight: 900;
font-size: 20px;
cursor: pointer;
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
transition: all 0.3s ease;
z-index: 9999;
display: none;
align-items: center;
justify-content: center;
opacity: 1;
visibility: visible;
}





#scroll-to-bottom:hover {
background: rgba(230, 36, 41, 1);
transform: translateX(-50%) translateY(-3px);
box-shadow: 0 6px 20px rgba(230, 36, 41, 0.6);
}

#scroll-to-bottom .new-messages {
font-size: 20px;
font-weight: 900;
color: #FFFFFF;
line-height: 1;
}


#scroll-to-bottom.show {
opacity: 1 !important;
visibility: visible !important;
pointer-events: auto;
}

.message {
margin-bottom: 20px;
opacity: 1;
transform: translateX(0) scale(1) rotateY(25deg) rotateX(-5deg);
flex-shrink: 0;
overflow: visible;
position: relative;
transform-style: flat;
transform-origin: left center;
}
.message.animate-in {
opacity: 0;
transform: translateX(-150px) scale(0.8) rotateY(25deg) rotateX(-5deg);
transition: opacity 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55),
transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.message.visible {
opacity: 1;
transform: translateX(0) scale(1) rotateY(25deg) rotateX(-5deg);
animation: pulse 1.5s ease-in-out 0.8s infinite;
}
@keyframes pulse {
0%, 100% { transform: translateX(0) scale(1) rotateY(25deg) rotateX(-5deg); }
50% { transform: translateX(0) scale(1.05) rotateY(25deg) rotateX(-5deg); }
}
@keyframes pulseBadge {
0%, 100% {
transform: scale(1);
}
50% {
transform: scale(1.15);
}
}
@keyframes vibrate-big {
  0%, 100% { transform: rotate(0deg); }
  15% { transform: rotate(-8deg); }
  30% { transform: rotate(8deg); }
  45% { transform: rotate(-6deg); }
  60% { transform: rotate(6deg); }
  75% { transform: rotate(-3deg); }
  90% { transform: rotate(3deg); }
}

@keyframes vibrate-small {
  0%, 100% { transform: rotate(0deg); }
  20% { transform: rotate(-6deg); }
  40% { transform: rotate(6deg); }
  60% { transform: rotate(-4deg); }
  80% { transform: rotate(4deg); }
}
.message.fading {
opacity: 0;
transition: opacity 1.5s ease-out;
}
.message.hidden {
opacity: 0;
transform: translateX(-150px) scale(0.8) rotateY(25deg) rotateX(-5deg);
max-height: 0px !important;
margin-bottom: 0px !important;
}
.message svg {
display: block;
filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.6));
}
.username-text {
font-family: 'Poppins', sans-serif;
font-weight: 900;
font-size: 18px;
fill: #FFFFFF;
}
.message-text {
font-family: 'Poppins', sans-serif;
font-weight: 700;
font-size: 22px;
fill: #FFFFFF;
}
.badge-image {
position: absolute;
vertical-align: middle;
}

.loading-dots {
display: block;
margin: 20px 0;
}
.loading-dots svg {
filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
}

/* Running text untuk special bubble */
.running-text-container {
position: relative;
width: 450px;
height: 40px;
overflow: hidden;
background: #000000;
clip-path: polygon(2% 0, 100% 0, 95% 100%, 0 100%);
}

.running-text {
position: absolute;
white-space: nowrap;
font-family: 'Poppins', sans-serif;
font-weight: 700;
font-size: 18px;
color: #FFFFFF;
line-height: 40px;
padding: 0 20px;
animation: scroll-text 15s linear infinite;
}

@keyframes scroll-text {
0% {
transform: translateX(100%);
}
100% {
transform: translateX(-100%);
}
}

#demo-button {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 30px;
background: linear-gradient(135deg, #E62429, #FF4458);
color: white;
border: none;
border-radius: 10px;
font-family: 'Poppins', sans-serif;
font-weight: 700;
font-size: 16px;
cursor: pointer;
box-shadow: 0 4px 15px rgba(230, 36, 41, 0.4);
transition: all 0.3s ease;
z-index: 9999;
}
#demo-button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(230, 36, 41, 0.6);
}
#demo-button:active {
transform: translateY(0);
}

/* Style untuk emote di dalam foreignObject */
foreignObject img {
  display: inline-block !important;
  vertical-align: middle !important;
  height: 40px !important;
  width: auto !important;
  max-height: 40px !important;
  max-width: 36px !important;
  margin: 0 3px !important;
  object-fit: contain !important;
}
/* Style untuk emote di running text container */
.running-text img {
  display: inline-block !important;
  vertical-align: middle !important;
  height: 40px !important;
  width: auto !important;
  max-height: 40px !important;
  max-width: 36px !important;
  margin: 0 3px !important;
  object-fit: contain !important;
}
body, html {
border: none !important;
outline: none !important;
box-shadow: none !important;
}

* {
border: none !important;
outline: none !important;
}

</style>
</head>
<body>
<button id="demo-button">Send Demo Message</button>
<button id="scroll-to-bottom">
  <span class="new-messages">5</span>
</button>
<div id="chat-container">
<div id="message-list-wrapper"></div>
</div>
<script>
var urlParams = new URLSearchParams(window.location.search);
var roomID = urlParams.has("session") ? urlParams.get("session") : "fftWZkZCmp";
var password = urlParams.has("password") ? urlParams.get("password") : "false";
var featuredMode = false;
const messageListWrapper = document.getElementById('message-list-wrapper');
const MAX_MESSAGES = urlParams.has("limit") ? parseInt(urlParams.get("limit")) : 20;
const SHOW_TIME = urlParams.has("showtime") ? parseInt(urlParams.get("showtime")) : 30000;
const messageTimestamps = new Map();
let isUserScrolling = false;
let newMessagesCount = 0;
let autoHidePaused = false;

// Detect user scroll
messageListWrapper.addEventListener('scroll', () => {
  const scrollTop = messageListWrapper.scrollTop;
  const scrollHeight = messageListWrapper.scrollHeight;
  const clientHeight = messageListWrapper.clientHeight;
  
  // Check if scrolled to bottom (within 50px threshold)
  const isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
  
  if (isAtBottom) {
    isUserScrolling = false;
    autoHidePaused = false;
    newMessagesCount = 0;
    document.getElementById('scroll-to-bottom').classList.remove('show');
  } else {
    isUserScrolling = true;
    autoHidePaused = true;
    document.getElementById('scroll-to-bottom').classList.add('show');
  }
  
  updateNewMessagesBadge();
});

// Back to bottom button click
document.getElementById('scroll-to-bottom').addEventListener('click', () => {
  messageListWrapper.scrollTop = messageListWrapper.scrollHeight;
  isUserScrolling = false;
  autoHidePaused = false;
  newMessagesCount = 0;
  document.getElementById('scroll-to-bottom').classList.remove('show');
  updateNewMessagesBadge();
});

function updateNewMessagesBadge() {
  const badge = document.querySelector('.new-messages');
  if (badge) {
    badge.textContent = newMessagesCount;
  }
}

function scrollToBottom() {
// Increment new messages counter kalau user scroll
if (isUserScrolling) {
  newMessagesCount++;
  updateNewMessagesBadge();
}
}



function adjustMessageWrapperScroll() {
  requestAnimationFrame(() => {
    messageListWrapper.style.transform = 'rotateY(25deg) rotateX(-5deg) translateY(0)';
  });
}

setInterval(() => {
  // PAUSE auto-hide kalau user scroll
  if (autoHidePaused) return;
  
  const now = Date.now();
  const messages = Array.from(messageListWrapper.querySelectorAll('.message'));
  messages.forEach(message => {
    const timestamp = messageTimestamps.get(message.id);
    if (timestamp) {
      const age = now - timestamp;
      if (age > SHOW_TIME && !message.classList.contains('fading')) {
        message.classList.add('fading');
        setTimeout(() => {
          if (message.parentNode) {
            messageTimestamps.delete(message.id);
            message.parentNode.removeChild(message);
          }
        }, 1500);
      }
    }
  });
}, 1000);

function wrapText(text, maxCharsPerLine) {
  if (!text) return [];
  const words = text.split(' ');
  const lines = [];
  let currentLine = '';
  words.forEach(word => {
    const testLine = currentLine ? currentLine + ' ' + word : word;
    if (testLine.length > maxCharsPerLine && currentLine) {
      lines.push(currentLine);
      currentLine = word;
    } else {
      currentLine = testLine;
    }
  });
  if (currentLine) {
    lines.push(currentLine);
  }
  return lines;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function resizeUsernameBox(messageDiv, username) {
  requestAnimationFrame(() => {
    const usernameText = messageDiv.querySelector('.username-text');
    const usernameBg = messageDiv.querySelector('.username-bg');
    const usernameInner = messageDiv.querySelector('.username-inner');
    if (!usernameText || !usernameBg || !usernameInner) return;

    const bbox = usernameText.getBBox();
    const textWidth = bbox.width;
    const paddingLeft = 10;
    const paddingRight = 40;
    const totalWidth = textWidth + paddingLeft + paddingRight;

    const outerRight = totalWidth + 10;
    const outerRightBottom = totalWidth - 18;
    usernameBg.setAttribute('points', `10,0 ${outerRight},0 ${outerRightBottom},36 10,36`);

    const innerRight = totalWidth + 5;
    const innerRightBottom = totalWidth - 20;
    usernameInner.setAttribute('points', `15,5 ${innerRight},5 ${innerRightBottom},31 15,31`);
  });
}

// FUNGSI UNTUK CEK TRIGGER SUBSCRIBE/FOLLOW
function isSpecialEvent(message) {
  if (!message) return null;
  const lowerMsg = message.toLowerCase();
  
  if (lowerMsg.includes('aku sudah sub')) {
    return 'youtube';
  }
  if (lowerMsg.includes('aku sudah follow')) {
    return 'twitch';
  }
  return null;
}

// FUNGSI UNTUK MEMBUAT SPECIAL BUBBLE
function createSpecialBubble(data, platform) {
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message');
  const messageId = data.mid || 'msg-special-' + Date.now() + '-' + Math.random();
  messageDiv.id = messageId;
  messageTimestamps.set(messageId, Date.now());

  const username = escapeHtml(data.chatname || 'Anonymous');
// Prioritas chatmessageHTML biar emote muncul
let userMessage = data.chatmessageHTML || data.chatmessage || '';
// Bersihkan placeholder [Emote]
userMessage = userMessage
  .replace(/üéÆ\s*\[Emote\]\s*-?\s*/gi, '')
  .replace(/\[Emote\]\s*-?\s*/gi, '')
  .replace(/^\s*-\s*/, '')
  .trim();

  
// WARNA BERDASARKAN PLATFORM
let bubbleColor = '#E62429';
let welcomeText = 'WELCOME TO BAMBOO SQUAD';

if (platform === 'youtube') {
  bubbleColor = '#FF0000';
  welcomeText = 'WELCOME TO BAMBOO SQUAD';
} else if (platform === 'twitch') {
  bubbleColor = '#6441A5';
  welcomeText = 'WELCOME TO BAMBOO SQUAD';
} else if (platform === 'donation') {
  bubbleColor = '#6441A5'; // UNGU KAYAK TWITCH
  // Ambil amount dari data
  const tipAmount = data.donation || data.amount || 0;
  welcomeText = `MEMBERIKAN TIP $${tipAmount}`;
} else if (platform === 'cheer') {
  bubbleColor = '#6441A5'; // UNGU KAYAK TWITCH
  // Ambil bits dari data
  const cheerAmount = data.bits || data.amount || 0;
  welcomeText = `MEMBERIKAN ${cheerAmount} CHEER`;
}



  const bubbleWidth = 550;
  const bubbleHeight = 160;
  const svgHeight = bubbleHeight + 40;
  
  const bubbleEnd = bubbleWidth - 95;
  const bubblePointsBlack = `-5,-5 ${bubbleWidth + 10},-5 ${bubbleEnd + 10},${bubbleHeight + 50} -40,${bubbleHeight + 5}`;
  const bubblePoints = `0,0 ${bubbleWidth},0 ${bubbleEnd},${bubbleHeight} -35,${bubbleHeight}`;
  const bubbleInnerWhite = `5,5 ${bubbleWidth - 5},5 ${bubbleEnd - 2},${bubbleHeight - 5} -30,${bubbleHeight - 5}`;
  const bubbleInnerColor = `10,10 ${bubbleWidth - 10},10 ${bubbleEnd - 5},${bubbleHeight - 10} -22,${bubbleHeight - 10}`;

// Loading animation - BERBEDA UNTUK SEMUA PLATFORM
const loadingDiv = document.createElement('div');
loadingDiv.className = 'loading-dots';

if (platform === 'donation') {
  // TIP/DONATION: 3 Money emoji pulse
  loadingDiv.innerHTML = `
<svg width="150" height="80" viewBox="0 0 150 80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="border-glow-${platform}-${Date.now()}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5"/>
    </filter>
  </defs>
  
  <rect x="10" y="10" width="130" height="60" fill="none" stroke="${bubbleColor}" stroke-width="10" filter="url(#border-glow-${platform}-${Date.now()})"/>
  <rect x="10" y="10" width="130" height="60" fill="#000000" stroke="${bubbleColor}" stroke-width="3"/>
  
  <!-- Emoji 1 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
    <foreignObject x="25" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">üí∞</div>
    </foreignObject>
  </g>
  
  <!-- Emoji 2 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
    <foreignObject x="65" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">üí∞</div>
    </foreignObject>
  </g>
  
  <!-- Emoji 3 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
    <foreignObject x="105" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">üí∞</div>
    </foreignObject>
  </g>
</svg>
`;

} else if (platform === 'cheer') {
  // CHEER/BITS: 3 Sparkle emoji pulse
  loadingDiv.innerHTML = `
<svg width="150" height="80" viewBox="0 0 150 80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="border-glow-${platform}-${Date.now()}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5"/>
    </filter>
  </defs>
  
  <rect x="10" y="10" width="130" height="60" fill="none" stroke="${bubbleColor}" stroke-width="10" filter="url(#border-glow-${platform}-${Date.now()})"/>
  <rect x="10" y="10" width="130" height="60" fill="#000000" stroke="${bubbleColor}" stroke-width="3"/>
  
  <!-- Emoji 1 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
    <foreignObject x="25" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">‚ú®</div>
    </foreignObject>
  </g>
  
  <!-- Emoji 2 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
    <foreignObject x="65" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">‚ú®</div>
    </foreignObject>
  </g>
  
  <!-- Emoji 3 -->
  <g opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
    <foreignObject x="105" y="25" width="30" height="30">
      <div xmlns="http://www.w3.org/1999/xhtml" style="font-size:22px; text-align:center;">‚ú®</div>
    </foreignObject>
  </g>
</svg>
`;

} else if (platform === 'youtube' || platform === 'twitch') {
  // SUBSCRIBE/FOLLOW: 3 HATI dengan pulse
  loadingDiv.innerHTML = `
<svg width="150" height="80" viewBox="0 0 150 80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="border-glow-${platform}-${Date.now()}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5"/>
    </filter>
  </defs>
  
  <rect x="10" y="10" width="130" height="60" fill="none" stroke="${bubbleColor}" stroke-width="10" filter="url(#border-glow-${platform}-${Date.now()})"/>
  <rect x="10" y="10" width="130" height="60" fill="#000000" stroke="${bubbleColor}" stroke-width="3"/>
  
  <!-- Hati 1 -->
  <path d="M 12,5 C 12,2.5 10,1 8,1 C 6,1 4.5,2.5 4.5,4 C 4.5,2.5 3,1 1,1 C -1,1 -2.5,2.5 -2.5,5 C -2.5,9 4.5,14 4.5,14 C 4.5,14 12,9 12,5 Z" 
        fill="${bubbleColor}" opacity="0" transform="translate(30, 28) scale(1.5)">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
    <animateTransform attributeName="transform" type="scale" additive="sum" 
                      values="0 0; 1.2 1.2; 1 1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
  </path>
  
  <!-- Hati 2 -->
  <path d="M 12,5 C 12,2.5 10,1 8,1 C 6,1 4.5,2.5 4.5,4 C 4.5,2.5 3,1 1,1 C -1,1 -2.5,2.5 -2.5,5 C -2.5,9 4.5,14 4.5,14 C 4.5,14 12,9 12,5 Z" 
        fill="${bubbleColor}" opacity="0" transform="translate(70, 28) scale(1.5)">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
    <animateTransform attributeName="transform" type="scale" additive="sum" 
                      values="0 0; 1.2 1.2; 1 1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
  </path>
  
  <!-- Hati 3 -->
  <path d="M 12,5 C 12,2.5 10,1 8,1 C 6,1 4.5,2.5 4.5,4 C 4.5,2.5 3,1 1,1 C -1,1 -2.5,2.5 -2.5,5 C -2.5,9 4.5,14 4.5,14 C 4.5,14 12,9 12,5 Z" 
        fill="${bubbleColor}" opacity="0" transform="translate(110, 28) scale(1.5)">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
    <animateTransform attributeName="transform" type="scale" additive="sum" 
                      values="0 0; 1.2 1.2; 1 1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
  </path>
</svg>
`;

} else {
  // FALLBACK: 3 dots klasik
  loadingDiv.innerHTML = `
<svg width="150" height="80" viewBox="0 0 150 80" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="border-glow-${platform}-${Date.now()}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="5"/>
    </filter>
  </defs>
  
  <rect x="10" y="10" width="130" height="60" fill="none" stroke="${bubbleColor}" stroke-width="10" filter="url(#border-glow-${platform}-${Date.now()})"/>
  <rect x="10" y="10" width="130" height="60" fill="#000000" stroke="${bubbleColor}" stroke-width="3"/>
  
  <circle cx="40" cy="40" r="10" fill="${bubbleColor}" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
    <animate attributeName="r" values="0;12;10" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
  </circle>
  
  <circle cx="75" cy="40" r="10" fill="${bubbleColor}" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
    <animate attributeName="r" values="0;12;10" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
  </circle>
  
  <circle cx="110" cy="40" r="10" fill="${bubbleColor}" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
    <animate attributeName="r" values="0;12;10" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
  </circle>
</svg>
`;
}





  // Main content
  const contentDiv = document.createElement('div');
  contentDiv.style.position = 'relative';
  contentDiv.innerHTML = `
<svg width="700" height="${svgHeight}" viewBox="0 0 700 ${svgHeight}" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <defs>
    <!-- Filter blur untuk border kotak bubble -->
    <filter id="bubble-border-glow-${platform}" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10"/>
    </filter>
  </defs>
  
  <g transform="translate(60, 20)">
    <!-- Layer 0: GLOW BORDER (paling belakang, HARUS PERTAMA!) -->
    <polygon points="${bubbleInnerWhite}" fill="none" stroke="${bubbleColor}" stroke-width="40" filter="url(#bubble-border-glow-${platform})"/>
    
    <!-- Layer 1: Hitam -->
    <polygon points="${bubblePointsBlack}" fill="#000000"/>
    <!-- Layer 2: Putih -->
    <polygon points="${bubbleInnerWhite}" fill="#FFFFFF"/>
    <!-- Layer 3: Merah/Ungu -->
    <polygon points="${bubbleInnerColor}" fill="${bubbleColor}"/>
  </g>
  
  <!-- Avatar, username, text, dll... -->



  <!-- Username Text (tanpa kotak) -->
  <text class="username-text" x="75" y="60" fill="#FFFFFF" font-size="22" font-weight="900">${username}</text>

  <!-- Welcome Text -->
<text x="75" y="110" fill="#FFFFFF" font-size="48" font-weight="400" font-family="'Bebas Neue', sans-serif">"${welcomeText}"</text>



<!-- Icon Tanda Seru Besar dengan animasi PULSE -->
<g transform="translate(${bubbleWidth + 40}, -50) rotate(60, 15, 35) scale(2.8)">
  <path d="M 10 0 L 20 0 L 18 28 L 12 28 Z" fill="#000000">
    <animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; 1.2 1.2; 0.9 0.9; 1.15 1.15; 1 1" dur="0.5s" begin="0.8s" fill="freeze"/>
  </path>
  <path d="M 12 3 L 18 3 L 16.5 25 L 13.5 25 Z" fill="#FFFFFF">
    <animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; 1.2 1.2; 0.9 0.9; 1.15 1.15; 1 1" dur="0.5s" begin="0.8s" fill="freeze"/>
  </path>
</g>

<!-- Icon Tanda Seru Kecil dengan animasi PULSE -->
<g transform="translate(${bubbleWidth + 42}, -15) rotate(80, 15, 35) scale(2)">
  <path d="M 10 0 L 20 0 L 18 28 L 12 28 Z" fill="#000000">
    <animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; 1.15 1.15; 0.95 0.95; 1.1 1.1; 1 1" dur="0.4s" begin="1s" fill="freeze"/>
  </path>
  <path d="M 12 3 L 18 3 L 16.5 25 L 13.5 25 Z" fill="#FFFFFF">
    <animateTransform attributeName="transform" type="scale" additive="sum" values="1 1; 1.15 1.15; 0.95 0.95; 1.1 1.1; 1 1" dur="0.4s" begin="1s" fill="freeze"/>
  </path>
</g>

  <!-- Foreign Object untuk running text HTML - Tanpa border, pojok miring -->
<foreignObject x="70" y="120" width="460" height="50">
  <div xmlns="http://www.w3.org/1999/xhtml" class="running-text-container">
    <div class="running-text">${userMessage}</div>
  </div>
</foreignObject>
</svg>
`;

  loadingDiv.style.display = 'block';
  contentDiv.style.opacity = '0';
  contentDiv.style.visibility = 'hidden';
  contentDiv.style.display = 'block';
  contentDiv.style.transform = 'translateX(-150px) scale(0.8)';
  contentDiv.style.transition = 'opacity 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

  messageDiv.appendChild(loadingDiv);
  messageDiv.appendChild(contentDiv);

  const firstMessage = messageListWrapper.querySelector('.message');
  if (firstMessage) {
    messageListWrapper.insertBefore(messageDiv, firstMessage);
  } else {
    messageListWrapper.appendChild(messageDiv);
  }

  void messageDiv.offsetWidth;

  setTimeout(() => {
    loadingDiv.style.display = 'none';
    contentDiv.style.visibility = 'visible';
    void contentDiv.offsetWidth;
    contentDiv.style.opacity = '1';
    contentDiv.style.transform = 'translateX(0) scale(1)';
    
    setTimeout(() => {
      messageDiv.classList.add('visible');
    }, 800);
  }, 1500);

  const messages = Array.from(messageListWrapper.querySelectorAll('.message'));
  if (messages.length > MAX_MESSAGES) {
    const oldestMessage = messages[messages.length - 1];
    if (oldestMessage) {
      messageTimestamps.delete(oldestMessage.id);
      messageListWrapper.removeChild(oldestMessage);
    }
  }

  adjustMessageWrapperScroll();
}

function addMessageToOverlay(data) {
  if (!data.chatname && !data.chatmessage && !data.hasDonation && !data.donation) {
    return;
  }

  // CEK APAKAH INI SPECIAL EVENT
  const specialEvent = isSpecialEvent(data.chatmessage);
  if (specialEvent) {
    createSpecialBubble(data, specialEvent);
    return;
  }

  // BUBBLE NORMAL (kode asli kamu)
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message');
  const messageId = data.mid || 'msg-' + Date.now() + '-' + Math.random();
  messageDiv.id = messageId;
  messageTimestamps.set(messageId, Date.now());

let messageText = '';
console.log('DEBUG DATA:', data);
if (data.hasDonation) {
  messageText = data.hasDonation;
}

// Prioritaskan chatmessageHTML (ada emote image)
if (data.chatmessageHTML) {
  messageText += (messageText ? ' - ' : '') + data.chatmessageHTML;
} else if (data.chatmessage) {
  messageText += (messageText ? ' - ' : '') + data.chatmessage;
}

// BERSIHKAN placeholder "[Emote]" dari SocialStream
messageText = messageText
  .replace(/üéÆ\s*\[Emote\]\s*-?\s*/gi, '')
  .replace(/\[Emote\]\s*-?\s*/gi, '')
  .replace(/^\s*-\s*/, '')
  .trim();

// Skip kalau message akhirnya kosong
if (!messageText || messageText.trim() === '') {
  console.log('SKIP: Empty message after cleanup');
  return;
}

// Estimasi line count LEBIH AKURAT (word wrapping)
const tempDiv = document.createElement('div');
tempDiv.innerHTML = messageText;
const plainText = tempDiv.textContent || tempDiv.innerText || '';

// Hitung berdasarkan wrap manual
const words = plainText.split(' ');
let currentLength = 0;
let lines = 1;
words.forEach(word => {
  if (currentLength + word.length > 35) { // 35 char per line
    lines++;
    currentLength = word.length;
  } else {
    currentLength += word.length + 1; // +1 untuk spasi
  }
});

const lineCount = Math.max(1, Math.min(lines, 5)); // Min 1, max 5



  const bubbleWidth = 520;
  const bubbleWidthInner = 498;
  const bubbleEnd = 435;

  const paddingTop = 55;
  const lineHeight = 26;
  const paddingBottom = 30;
  const bubbleHeight = paddingTop + (lineCount * lineHeight) + paddingBottom;

  const svgHeight = bubbleHeight + 40;
  const bubblePoints = `0,0 ${bubbleWidth},0 ${bubbleEnd},${bubbleHeight} 0,${bubbleHeight}`;
  const bubbleInnerPoints = `7,7 ${bubbleWidthInner},7 ${bubbleEnd - 3},${bubbleHeight - 7} 7,${bubbleHeight - 7}`;


  let accentColor = '#E62429';
  if (data.nameColor) {
    accentColor = data.nameColor;
  } else if (typeof getColorFromType === 'function' && data.type) {
    try {
      const typeColor = getColorFromType(data.type);
      if (typeColor) accentColor = typeColor;
    } catch (e) {
      console.error("Error getting color:", e);
    }
  }

  let badgesData = [];
  if (data.chatbadges && Array.isArray(data.chatbadges)) {
    data.chatbadges.forEach((badge) => {
      let badgeSrc = '';
      if (typeof badge === "object" && badge.src) {
        badgeSrc = badge.src;
      } else if (typeof badge === "string") {
        badgeSrc = badge;
      }
      if (badgeSrc) {
        badgesData.push(badgeSrc);
      }
    });
  }

  let platformIconHtml = '';
  if (data.type) {
    platformIconHtml = `<image x="10" y="38" width="25" height="25" href="https://socialstream.ninja/sources/images/${data.type}.png" style="opacity: 0.9;"/>`;
  }

// GUNAKAN foreignObject untuk render HTML (termasuk emote image)
const messageTextElements = `
<foreignObject x="120" y="${paddingTop - 5}" width="${bubbleWidth - 130}" height="${bubbleHeight - paddingTop + 10}">
  <div xmlns="http://www.w3.org/1999/xhtml" style="
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    font-size: 22px;
    color: #FFFFFF;
    line-height: 28px;
    overflow-wrap: break-word;
    word-wrap: break-word;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
  ">
    ${messageText}
  </div>
</foreignObject>
`;


  const avatarUrl = data.chatimg || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23E62429" width="100" height="100"/%3E%3C/svg%3E';
  const username = escapeHtml(data.chatname || 'Anonymous');

  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'loading-dots';
  loadingDiv.innerHTML = '';
  void loadingDiv.offsetWidth;
  loadingDiv.innerHTML = `
<svg width="150" height="80" viewBox="0 0 150 80" xmlns="http://www.w3.org/2000/svg">
  <rect x="10" y="10" width="130" height="60" fill="#000000" stroke="#FFFFFF" stroke-width="3"/>
  <circle cx="40" cy="40" r="8" fill="#FFFFFF" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
    <animate attributeName="r" values="0;10;8" keyTimes="0;0.5;1" dur="0.5s" begin="0s" fill="freeze"/>
  </circle>
  <circle cx="75" cy="40" r="8" fill="#FFFFFF" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
    <animate attributeName="r" values="0;10;8" keyTimes="0;0.5;1" dur="0.5s" begin="0.4s" fill="freeze"/>
  </circle>
  <circle cx="110" cy="40" r="8" fill="#FFFFFF" opacity="0">
    <animate attributeName="opacity" values="0;1;1" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
    <animate attributeName="r" values="0;10;8" keyTimes="0;0.5;1" dur="0.5s" begin="0.8s" fill="freeze"/>
  </circle>
</svg>
`;

  const contentDiv = document.createElement('div');
  contentDiv.style.position = 'relative';
  contentDiv.innerHTML = `
<svg width="700" height="${svgHeight}" viewBox="0 0 700 ${svgHeight}" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <g transform="translate(75, 20)">
    <polygon points="${bubblePoints}" fill="#FFFFFF"/>
    <polygon points="${bubbleInnerPoints}" fill="#000000"/>
  </g>

  <g transform="translate(5, 35) rotate(-3, 55, 46)">
    <polygon points="0,0 110,0 110,82 10,92" fill="#FFFFFF"/>
    <polygon points="6,6 104,6 104,78 12,86" fill="${accentColor}"/>
    <defs>
      <clipPath id="avatar-clip-${messageId}">
        <polygon points="6,6 104,6 104,78 12,86"/>
      </clipPath>
    </defs>
    <image x="6" y="6" width="98" height="80" href="${avatarUrl}" clip-path="url(#avatar-clip-${messageId})" preserveAspectRatio="xMidYMid slice"/>
  </g>

  ${platformIconHtml}

  <g class="username-group" transform="translate(100, 6) rotate(-2, 90, 18)">
    <polygon class="username-bg" points="10,0 170,0 142,36 10,36" fill="#FFFFFF"/>
    <polygon class="username-inner" points="15,5 160,5 140,31 15,31" fill="#000000"/>
    <text class="username-text" x="25" y="23" text-anchor="start">${username}</text>
  </g>

  ${messageTextElements}

  <g class="badge-exclamation" transform="translate(533, -40) rotate(15, 15, 25) scale(3)">
    <path d="M 10 0 L 20 0 L 18 20 L 12 20 Z" fill="#FFFFFF"/>
    <rect x="12" y="23" width="6" height="6" fill="#FFFFFF"/>
    <path d="M 12 3 L 18 3 L 16.5 18 L 13.5 18 Z" fill="#000000"/>
    <rect x="13.5" y="24.5" width="3" height="3" fill="#000000"/>
  </g>
</svg>
`;

  loadingDiv.style.display = 'block';
  contentDiv.style.opacity = '0';
  contentDiv.style.visibility = 'hidden';
  contentDiv.style.display = 'block';
  contentDiv.style.transform = 'translateX(-150px) scale(0.8)';
  contentDiv.style.transition = 'opacity 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

  messageDiv.appendChild(loadingDiv);
  messageDiv.appendChild(contentDiv);

  const firstMessage = messageListWrapper.querySelector('.message');
  if (firstMessage) {
    messageListWrapper.insertBefore(messageDiv, firstMessage);
  } else {
    messageListWrapper.appendChild(messageDiv);
  }

  void messageDiv.offsetWidth;

  setTimeout(() => {
    loadingDiv.style.display = 'none';
    contentDiv.style.visibility = 'visible';
    void contentDiv.offsetWidth;
    contentDiv.style.opacity = '1';
    contentDiv.style.transform = 'translateX(0) scale(1)';
    resizeUsernameBox(messageDiv, username);
    
    if (badgesData.length > 0) {
      requestAnimationFrame(() => {
        const usernameBg = messageDiv.querySelector('.username-bg');
        if (usernameBg) {
          const points = usernameBg.getAttribute('points').split(' ');
          const lastPoint = points[1].split(',');
          const usernameEndX = parseFloat(lastPoint[0]);
          
          const svg = messageDiv.querySelector('svg');
          const badgesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          badgesGroup.setAttribute('transform', 'translate(100, 6)');
          
          badgesData.forEach((badgeSrc, index) => {
            const xPos = usernameEndX + 10 + (index * 25);
            const badgeImg = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            badgeImg.setAttribute('x', xPos);
            badgeImg.setAttribute('y', '10');
            badgeImg.setAttribute('width', '20');
            badgeImg.setAttribute('height', '20');
            badgeImg.setAttribute('href', badgeSrc);
            badgeImg.classList.add('badge-image');
            badgesGroup.appendChild(badgeImg);
          });
          
          svg.appendChild(badgesGroup);
        }
      });
    }
    
    setTimeout(() => {
      messageDiv.classList.add('visible');
    }, 800);
  }, 1500);

  const messages = Array.from(messageListWrapper.querySelectorAll('.message'));
  if (messages.length > MAX_MESSAGES) {
    const oldestMessage = messages[messages.length - 1];
    if (oldestMessage) {
      messageTimestamps.delete(oldestMessage.id);
      messageListWrapper.removeChild(oldestMessage);
    }
  }

  adjustMessageWrapperScroll();
  
  // Increment new messages counter kalau user scroll
if (isUserScrolling) {
  newMessagesCount++;
  updateNewMessagesBadge();
}

}


// iframe setup
var iframe = document.createElement("iframe");
if (featuredMode) {
  iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
} else {
  iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password="+password+"&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room="+roomID;
}
iframe.style.cssText = "width: 0px; height: 0px; position: fixed; left: -100px; top: -100px;";
document.body.appendChild(iframe);

window.addEventListener("message", function (e) {
  if (e.source != iframe.contentWindow) return;
  if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
    addMessageToOverlay(e.data.dataReceived.overlayNinja);
  }
});

// websocket
var conCon = 1;
var socketserver = false;
var serverURL = urlParams.has("localserver") ? "ws://127.0.0.1:3000" : "wss://io.socialstream.ninja";

function setupSocket(){
  socketserver.onclose = function (){
    setTimeout(function(){
      conCon+=1;
      socketserver = new WebSocket(serverURL);
      setupSocket();
    },100*conCon);
  };
  socketserver.onopen = function (){
    conCon = 1;
    socketserver.send(JSON.stringify({"join":roomID, "out":3, "in":4}));
  };
  socketserver.addEventListener('message', function (event) {
    if (event.data){
      try {
        var data = JSON.parse(event.data);
        if (data) {
          addMessageToOverlay(data);
        }
      } catch (error) {
        console.error("Error processing WebSocket message:", error);
      }
    }
  });
}

if (urlParams.has("server") || urlParams.has("server2")){
  serverURL = urlParams.get("server") || urlParams.get("server2") || serverURL;
  socketserver = new WebSocket(serverURL);
  setupSocket();
}

console.log("Custom Chat Overlay Loaded! Session ID:", roomID);

// DEMO BUTTON
const demoButton = document.getElementById('demo-button');
let demoCounter = 0;
const demoMessages = [
  {
    chatname: "StreamerPro",
    chatmessage: "Halo semua! Ini pesan demo pertama üéÆ",
    chatimg: "https://i.pravatar.cc/150?img=1",
    type: "twitch",
    nameColor: "#9146FF",
    chatbadges: ["https://static-cdn.jtvnw.net/badges/v1/5d9f2208-5dd8-11e7-8513-2ff4adfae661/2"]
  },
  {
    chatname: "GamingKing",
    chatmessage: "aku sudah sub nih, semoga channelnya makin maju ya! Terima kasih banyak supportnya dan semoga terus berkembang",
    chatimg: "https://i.pravatar.cc/150?img=12",
    type: "youtube",
    nameColor: "#FF0000",
    chatbadges: []
  },
  {
    chatname: "ProPlayer88",
    chatmessage: "aku sudah follow dong, mantap streamnya! Keep up the good work bro",
    chatimg: "https://i.pravatar.cc/150?img=33",
    type: "twitch",
    nameColor: "#1877F2",
    chatbadges: []
  },
  {
    chatname: "StreamQueen",
    chatmessage: "Love it! ‚ù§Ô∏è Berapa harga bikin overlay gini?",
    chatimg: "https://i.pravatar.cc/150?img=45",
    type: "tiktok",
    nameColor: "#FF0050",
    chatbadges: []
  },
  {
    chatname: "ContentCreatorWithVeryLongName",
    chatmessage: "Tutorial dong cara bikinnya! Ini sangat bagus sekali untuk streaming setup profesional yang bagus dan cepat aku juga mau soalnya kerena aja gitu hasilnya",
    chatimg: "https://i.pravatar.cc/150?img=52",
    type: "twitch",
    nameColor: "#00D9FF",
    chatbadges: []
  },
  // ===== TAMBAHKAN 2 INI =====
  {
    chatname: "GenerousDonor",
    chatmessage: "Ini donasi untuk support stream! Keep it up!",
    chatimg: "https://i.pravatar.cc/150?img=8",
    type: 'donation',
    hasDonation: '$50 donation',
    donation: 50,
    nameColor: '#00D95F'
  },
  {
    chatname: "CheerMaster",
    chatmessage: "Cheer1000 mantap streamnya bro!",
    chatimg: "https://i.pravatar.cc/150?img=25",
    type: 'twitch',
    hasBits: true,
    bits: 1000,
    nameColor: '#9146FF'
  }
];


demoButton.addEventListener('click', function() {
  const demoData = demoMessages[demoCounter % demoMessages.length];
  
  // Cek apakah ini donation/cheer special event
  if (demoData.type === 'donation') {
    createSpecialBubble(demoData, 'donation');
  } else if (demoData.hasBits) {
    createSpecialBubble(demoData, 'cheer');
  } else {
    // Cek special event (sub/follow)
    const specialEvent = isSpecialEvent(demoData.chatmessage);
    if (specialEvent) {
      createSpecialBubble(demoData, specialEvent);
    } else {
      addMessageToOverlay(demoData);
    }
  }
  
  demoCounter++;
});

// ===== LISTEN DARI STREAMELEMENTS TIP & CHEER =====
window.addEventListener('message', function(e) {
  // Skip kalau bukan dari StreamElements
  if (!e.data || typeof e.data !== 'object') return;
  
  // Cek apakah ini StreamElements event
  if (e.data.type === 'SE_DONATION') {
    console.log('‚úÖ Received DONATION from StreamElements:', e.data.data);
    createSpecialBubble(e.data.data, 'donation');
  }
  
  if (e.data.type === 'SE_CHEER') {
    console.log('‚úÖ Received CHEER from StreamElements:', e.data.data);
    createSpecialBubble(e.data.data, 'cheer');
  }
});

// ===== STREAMELEMENTS DUAL PLATFORM INTEGRATION =====
const SE_JWT_YOUTUBE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjaXRhZGVsIiwiZXhwIjoxNzgyMjI1Njc5LCJqdGkiOiJkNTQxMDMzOC05M2U5LTQ2YTEtYWRmOS1jNTljNjIzMjY1MWYiLCJjaGFubmVsIjoiNjkxOTU5NTE1MWUyMDVmNzI1Y2VkYWNmIiwicm9sZSI6Im93bmVyIiwiYXV0aFRva2VuIjoiV010RENfWllkZFB0TjQyS0pCWlE5eVYtOWtMaWZLTjhzNWZVTF9TcmlWOFh1dkV4IiwidXNlciI6IjY5MTk1OTUxNTFlMjA1ZjcyNWNlZGFjZSIsInVzZXJfaWQiOiJhYTZlMDU5NS1mODRiLTRlYjktODg3NC04ZTU3ZDc5OGUzZWMiLCJ1c2VyX3JvbGUiOiJjcmVhdG9yIiwicHJvdmlkZXIiOiJ5b3V0dWJlIiwicHJvdmlkZXJfaWQiOiJVQzhnLUM5VF9IVGVnb2RyckZPajlEX0EiLCJjcmVhdG9yX2lkIjoiZGRiMDk2MzgtZmRlMC00OTg4LWIxMjEtNTMwNjVhODA1Njg2In0.matvGpA2hiWNdvju3oQ6tQZRe7oKteFD_sL9Hs7mtLg';
const SE_JWT_TWITCH = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjaXRhZGVsIiwiZXhwIjoxNzgyMjI1MzQ4LCJqdGkiOiIyNWUwNWNhZC01ZjJhLTQwNzAtOTc0ZC0xZDNmMDg5YzdlZWEiLCJjaGFubmVsIjoiNjhkNDI4NjM5NjYwOGQ1MjRjNzdkMTU2Iiwicm9sZSI6Im93bmVyIiwiYXV0aFRva2VuIjoiR25EaWh2dDBXc2JVQThpa3BDdTEyTjhYMm5teVU4LWNBRXplUEdOam8tQTlNYzVVIiwidXNlciI6IjY5MTk1OTUxNTFlMjA1ZjcyNWNlZGFjZSIsInVzZXJfaWQiOiJhYTZlMDU5NS1mODRiLTRlYjktODg3NC04ZTU3ZDc5OGUzZWMiLCJ1c2VyX3JvbGUiOiJjcmVhdG9yIiwicHJvdmlkZXIiOiJ0d2l0Y2giLCJwcm92aWRlcl9pZCI6Ijk4NDM3MDk1MSIsImNoYW5uZWxfaWQiOiI3ZTIwMjI3Ny02NWJkLTQwM2QtYjU0NS1mNzE4NDAwZTc0MTUiLCJjcmVhdG9yX2lkIjoiZGRiMDk2MzgtZmRlMC00OTg4LWIxMjEtNTMwNjVhODA1Njg2In0.eM6-AP4ume1a3vpyif0WGVkeNe10xLAUsJiypAUAHTE';

let seSocketYouTube;
let seSocketTwitch;

// Function untuk handle event dari StreamElements
function handleSEEvent(eventData, platform) {
  const type = eventData.type;
  
  // TIP/DONATION
  if (type === 'tip') {
    let avatarUrl = eventData.data.avatar || '';
    if (!avatarUrl || avatarUrl.includes('default-avatar')) {
      avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(eventData.data.username || 'Donor')}&background=E62429&color=fff&size=150`;
    }
    
    const tipData = {
      chatname: eventData.data.username || 'Anonymous',
      chatmessage: eventData.data.message || 'Thanks for the support!',
      chatimg: avatarUrl,
      type: 'donation',
      donation: parseFloat(eventData.data.amount) || 0,
      nameColor: '#00D95F'
    };
    
    console.log(`üí∞ [${platform}] Creating TIP bubble:`, tipData);
    createSpecialBubble(tipData, 'donation');
  }
  
  // CHEER/BITS (Twitch only)
  else if (type === 'cheer') {
    let avatarUrl = eventData.data.avatar || '';
    if (!avatarUrl || avatarUrl.includes('default-avatar')) {
      avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(eventData.data.username || 'Cheerer')}&background=9146FF&color=fff&size=150`;
    }
    
    const cheerData = {
      chatname: eventData.data.username || 'Anonymous',
      chatmessage: eventData.data.message || 'Cheer!',
      chatimg: avatarUrl,
      type: 'twitch',
      bits: parseInt(eventData.data.amount) || 0,
      nameColor: '#9146FF'
    };
    
    console.log(`üéâ [${platform}] Creating CHEER bubble:`, cheerData);
    createSpecialBubble(cheerData, 'cheer');
  }
  
  // SUPERCHAT (YouTube only)
  else if (type === 'superchat') {
    let avatarUrl = eventData.data.avatar || '';
    if (!avatarUrl || avatarUrl.includes('default-avatar')) {
      avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(eventData.data.username || 'Supporter')}&background=FF0000&color=fff&size=150`;
    }
    
    const superchatData = {
      chatname: eventData.data.username || 'Anonymous',
      chatmessage: eventData.data.message || 'Thanks for the Superchat!',
      chatimg: avatarUrl,
      type: 'youtube',
      donation: parseFloat(eventData.data.amount) || 0,
      nameColor: '#FF0000'
    };
    
    console.log(`üí∏ [${platform}] Creating SUPERCHAT bubble:`, superchatData);
    createSpecialBubble(superchatData, 'donation');
  }

 // SUBSCRIBER EVENT (YouTube)
  else if (type === 'subscriber') {
    let avatarUrl = eventData.data.avatar || '';
    if (!avatarUrl || avatarUrl.includes('default-avatar')) {
      avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(eventData.data.username || 'Subscriber')}&background=FF0000&color=fff&size=150`;
    }
    
    const subscriberData = {
      chatname: eventData.data.username || 'Anonymous',
      chatmessage: eventData.data.message || 'Thanks for subscribing!',
      chatimg: avatarUrl,
      type: 'youtube',
      nameColor: '#FF0000'
    };
    
    console.log(`üé¨ [${platform}] Creating SUBSCRIBER bubble:`, subscriberData);
    createSpecialBubble(subscriberData, 'youtube');
  }
  
  // FOLLOWER EVENT (Twitch)
  else if (type === 'follower' || type === 'follow') {
    let avatarUrl = eventData.data.avatar || '';
    if (!avatarUrl || avatarUrl.includes('default-avatar')) {
      avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(eventData.data.username || 'Follower')}&background=9146FF&color=fff&size=150`;
    }
    
    const followerData = {
      chatname: eventData.data.username || 'Anonymous',
      chatmessage: eventData.data.message || 'Thanks for following!',
      chatimg: avatarUrl,
      type: 'twitch',
      nameColor: '#9146FF'
    };
    
    console.log(`üíú [${platform}] Creating FOLLOWER bubble:`, followerData);
    createSpecialBubble(followerData, 'twitch');
  }
}


// Connect YouTube StreamElements
function connectSEYouTube() {
  if (!SE_JWT_YOUTUBE || SE_JWT_YOUTUBE === 'JWT_TOKEN_YOUTUBE_KAMU') {
    console.warn('‚ö†Ô∏è YouTube JWT Token not configured');
    return;
  }
  
  seSocketYouTube = new WebSocket('wss://realtime.streamelements.com/socket.io/?EIO=3&transport=websocket');
  
  seSocketYouTube.onopen = function() {
    console.log('‚úÖ Connected to StreamElements YouTube!');
    seSocketYouTube.send('42' + JSON.stringify(['authenticate', { method: 'jwt', token: SE_JWT_YOUTUBE }]));
  };
  
  seSocketYouTube.onmessage = function(event) {
    const message = event.data;
    
    if (message === '2' || message === '3') {
      if (message === '2') seSocketYouTube.send('3');
      return;
    }
    
    if (message.startsWith('42')) {
      try {
        const data = JSON.parse(message.substring(2));
        const eventType = data[0];
        const eventData = data[1];
        
        console.log('üì© [YouTube] StreamElements Event:', eventType, eventData);
        
        if (eventType === 'event:test' || eventType === 'event') {
          handleSEEvent(eventData, 'YouTube');
        }
      } catch (e) {
        console.error('[YouTube] Error parsing message:', e);
      }
    }
  };
  
  seSocketYouTube.onerror = function(error) {
    console.error('‚ùå [YouTube] StreamElements error:', error);
  };
  
  seSocketYouTube.onclose = function() {
    console.log('üîå [YouTube] Disconnected. Reconnecting in 5s...');
    setTimeout(connectSEYouTube, 5000);
  };
}

// Connect Twitch StreamElements
function connectSETwitch() {
  if (!SE_JWT_TWITCH || SE_JWT_TWITCH === 'JWT_TOKEN_TWITCH_KAMU') {
    console.warn('‚ö†Ô∏è Twitch JWT Token not configured');
    return;
  }
  
  seSocketTwitch = new WebSocket('wss://realtime.streamelements.com/socket.io/?EIO=3&transport=websocket');
  
  seSocketTwitch.onopen = function() {
    console.log('‚úÖ Connected to StreamElements Twitch!');
    seSocketTwitch.send('42' + JSON.stringify(['authenticate', { method: 'jwt', token: SE_JWT_TWITCH }]));
  };
  
  seSocketTwitch.onmessage = function(event) {
    const message = event.data;
    
    if (message === '2' || message === '3') {
      if (message === '2') seSocketTwitch.send('3');
      return;
    }
    
    if (message.startsWith('42')) {
      try {
        const data = JSON.parse(message.substring(2));
        const eventType = data[0];
        const eventData = data[1];
        
        console.log('üì© [Twitch] StreamElements Event:', eventType, eventData);
        
        if (eventType === 'event:test' || eventType === 'event') {
          handleSEEvent(eventData, 'Twitch');
        }
      } catch (e) {
        console.error('[Twitch] Error parsing message:', e);
      }
    }
  };
  
  seSocketTwitch.onerror = function(error) {
    console.error('‚ùå [Twitch] StreamElements error:', error);
  };
  
  seSocketTwitch.onclose = function() {
    console.log('üîå [Twitch] Disconnected. Reconnecting in 5s...');
    setTimeout(connectSETwitch, 5000);
  };
}

// Start both connections
connectSEYouTube();
connectSETwitch();

</script>
</body>
</html>
